<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="assets/images/logo2.PNG">
    <title>Davao Blue Eagle Scout - Cirva A La Gente Por La Musica</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/plugins/font-awesome/css/all.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/custom.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
             select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    } 

         </style>
    <script type="text/javascript">
    if (!localStorage.getItem("user")) {
        window.location.href = "login";
    }    

    document.addEventListener("DOMContentLoaded", function() {
    const currentUrl = window.location.href;
    const links = document.querySelectorAll('.accordion-menu a');

    links.forEach(link => {
        if (currentUrl.includes(link.getAttribute('href'))) {
            link.classList.add('active');
        }
    });
});


</script>
    
    </head>
    <body>
        <div style="position: fixed;top: 0px;left: 0px;width: 100%;background: #F4F7FC;z-index: 9999;padding: 0px;">
  <div class="lime-sidebar">
    <div class="lime-sidebar-inner slimscroll">
      <ul class="accordion-menu">
        <li class="sidebar-title">Navigations</li>
        <li><a href="dashboard"><i class="material-icons">dashboard</i><span>Dashboard</span></a></li>
        <li><a href="events"><i class="material-icons">event</i><span>Events</span></a></li>
        
        <li><a href="revenues"><i class="material-icons">trending_up</i><span>Revenues</span></a></li>
        <li><a href="payments"><i class="material-icons">payment</i><span>Payments</span></a></li>
        <li><a href="expenses"><i class="material-icons">request_quote</i><span>Expenses</span></a></li>
        <li><a href="attendance"><i class="material-icons">schedule</i><span>Attendance</span></a></li>
        <li><a href="users"><i class="material-icons">people</i><span>Users</span></a></li>
      </ul>
      <ul class="accordion-menu" id="Othersnav">
        <li class="divider"></li>
        <li class="sidebar-title">Others</li>
        <li><a href="dashboard"><i class="material-icons">settings</i><span>Account</span></a></li>
        <li><a onclick="localStorage.removeItem('user'); window.location.href = 'login';"><i class="material-icons">power_settings_new</i><span>Logout</span></a></li>
      </ul>
    </div>
  </div>

  <style>
    @media (max-width: 1024px) {
      #Othersnav {
        display: block;
      }
    }
    @media (min-width: 1025px) {
      #Othersnav {
        display: none;
      }
    }
  </style>

  <div class="lime-header" style="padding: 0px;">
    <nav class="navbar navbar-expand-lg">
      <section class="material-design-hamburger navigation-toggle">
        <a href="javascript:void(0)" class="button-collapse material-design-hamburger__icon">
          <span class="material-design-hamburger__layer"></span>
        </a>
      </section>
      <a class="navbar-brand" href="">
        <img src="assets/images/logo2.png" style="height: 75px;width: 75px;">
      </a>
      <button class="navbar-toggler" type="button"  style="margin-right: 10px" onclick="localStorage.removeItem('user'); window.location.href = 'login';">
        <i class="material-icons" style="font-size: 20px;">power_settings_new</i>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="material-icons">more_vert</i>
            </a>
            <ul class="dropdown-menu dropdown-menu-right">
              <li><a class="dropdown-item" href="#">Account</a></li>
              <li><a class="dropdown-item" onclick="localStorage.removeItem('user'); window.location.href = 'login';">Log Out</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </div>
</div>











        <div class="lime-container">
            <div class="lime-body" style="margin-top:100px">
                <div class="container">


                        
                    <div class="row">

                        <div class="col">

                            <div class="card">
                                <div class="card-body">
                                      <h5 class="card-title" style="text-align: center;">(<span style="color:#07102F" id="TotalRows"></span>) Payments record</h5>
    
                                    <div class="row">
<div class="col-12 col-md-12">
    <div class="todo-sidebar">
        <div class="row">
            <div class="col-12 col-md-6 mb-3">
                <div class="todo-new-task">
                    <button class="btn btn-primary btn-block" style="height:42px;" data-toggle="modal" data-target="#newAddPayment">Create New Payment</button>
                </div>
            </div>

            <div class="col-12 col-md-6 mb-3">
                <div class="todo-search m-b-lg">
                        <div class="input-group">
                            <input type="text" id="search" class="form-control" placeholder="Search Payment">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

                                        <div class="col-md-12">
                                              
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card stat-card">
                                <div class="card-body bg-warning">
                                    <h5 class="card-title" id="TheEventName">Total Amount Given</h5>
                                    <h2 class="float-right" id="TheEventDate" style="color:white;"></h2>
                                    <p style="color:white;font-weight: bold;" >DATE</p>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card">
                                <div class="card-body bg-info">
                                    <h5 class="card-title">Total Amount Paid</h5>
                                    <h2 class="float-right" id="TotalAmountPaid" style="color:white;"></h2>
                                    <p style="color:white;font-weight: bold;">PHP</p>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card">
                                <div class="card-body bg-success">
                                    <h5 class="card-title">Balance</h5>
                                    <h2 class="float-right" id="totalBalance" style="color:white;"></h2>
                                    <p style="color:white;font-weight: bold;">PHP</p>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

<div class="card">
    <div class="card-body" style="padding: 0px;">
        <div class="table-responsive">
            <table class="table" id="paymenttabledata">
        <thead>
            <tr>
                <th>Payment Date</th>
                <th>Mode of Payment</th>
                <th>Amount Paid</th>
                <th>Remarks</th>
                <th>Balance</th>
                <th>Date Received</th>
                <th>Officer</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="paymentTableBody"></tbody>
    </table>

        </div>
    </div>
</div>








                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>






            <div class="lime-footer">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <span class="footer-text">2025 Â© Davao Blue Eagle Scout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        


        

        <div class="modal fade" id="newAddPayment"  role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999999;background: rgba(0, 0, 0, 0.5);">
                                                        <div class="modal-dialog" role="document" >
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="exampleModalLabel">New Payment</h5>
                                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                        <i class="material-icons">close</i>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form id="newPaymentForm">

                 <input type="hidden" class="form-control" id="new_revenueId" name="revenueId" required>                                                       
    <div class="form-group">
        <label>Payment Date</label>
        <input type="date" class="form-control" id="new_paymentdate" name="paymentDate" required>
    </div>

    <div class="form-group">
        <label>Mode of Payment</label>

        <select class="form-control" id="new_modpayment" name="modeOfPayment" required>
           
        </select>
    </div>

    <div class="form-group">
        <input type="number" placeholder="Amount Paid" class="form-control" id="new_amountPaid" name="amountPaid" required min="0" step="0.01">
    </div>

    <div class="form-group">
        <label>Remarks</label>
    <select class="form-control" id="new_remarks" name="new_remarks" required></select>
    </div>

    <div class="form-group">
        <input type="number" placeholder="Balance" class="form-control" id="new_balance" name="balance" min="0" step="0.01">
    </div>

    <div class="form-group">
        <label>Date Received</label>
        <input type="date" class="form-control" id="new_dateReceived" name="dateReceived" required>
    </div>

    <div class="form-group">
        <select class="form-control" id="new_officerId" name="officerId" required>
            <!-- Options will be dynamically populated -->
        </select>
    </div>

    <div class="modal-footer" style="padding-right: 0px;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add New Payment</button>
    </div>
</form>

                                                                </div>
                                                                
                                                            </div>
                                                        </div>
                                                    </div>


    <div class="modal fade" id="editUsers" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999999;background: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit Payment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
    
    <input type="hidden" id="edit_paymentID" name="paymentID">

    <div class="form-group">
        <label>Payment Date</label>
        <input type="date" class="form-control" id="edit_paymentDate" name="paymentDate" required>
    </div>

    <div class="form-group">
        <label>Mode of Payment</label>
        <select class="form-control" id="edit_modePayment" name="modeOfPayment" required>
            <option value="Cash">Cash</option>
            <option value="Gcash">Gcash</option>
            <option value="Bank">Bank</option>
        </select>
    </div>

    <div class="form-group">
        <label>Amount Paid</label>
        <input type="number" class="form-control" id="edit_amountPaid" name="amountPaid" required min="0" step="0.01">
    </div>

    <div class="form-group">
        <label>Remarks</label>
        <select class="form-control" id="edit_remarks" name="remarks" required>
            <option value="Full">Full</option>
            <option value="Not Full">Not Full</option>
        </select>
    </div>

    <div class="form-group">
        <label>Balance</label>
        <input type="number" class="form-control" id="edit_balance" name="balance" min="0" step="0.01">
    </div>

    <div class="form-group">
        <label>Date Received</label>
        <input type="date" class="form-control" id="edit_dateReceived" name="dateReceived" required>
    </div>

    <div class="form-group">
        <label>Officer</label>
        <select class="form-control" id="edit_officerId" name="officerId" required>
            <!-- Populate dynamically -->
        </select>
    </div>

    <div class="modal-footer" style="padding-right: 0px;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
    </div>
</form>

                </div>
                
            </div>
        </div>
    </div>
</div>




    
    <script>
$(document).on("click", ".edit-btn", function () {
    const row = $(this).closest("tr");
    const paymentID = $(this).data("payment-id");

    const paymentDate = row.find("td:eq(0)").text();
    const modeOfPayment = row.find("td:eq(1)").text();
    const amountPaid = row.find("td:eq(2)").text();
    const remarks = row.find("td:eq(3)").text();
    const balance = row.find("td:eq(4)").text();
    const dateReceived = row.find("td:eq(5)").text();
    const officerName = row.find("td:eq(6)").text().trim();


    $("#edit_paymentID").val(paymentID);
    $("#edit_paymentDate").val(formatDate2(paymentDate));
    $("#edit_modePayment").val(modeOfPayment);
    $("#edit_amountPaid").val(amountPaid);
    $("#edit_remarks").val(remarks);
    $("#edit_balance").val(balance);
    $("#edit_dateReceived").val(formatDate(dateReceived));

    $.get("/get-officers", function (data) {
        const officerDropdown = $("#edit_officerId");
        officerDropdown.empty();
        officerDropdown.append('<option value="">Select Officer</option>');

        data.forEach(officer => {
            const fullName = `${officer.FirstName} ${officer.LastName}`;
            const selected = fullName === officerName ? "selected" : "";
            officerDropdown.append(`
                <option value="${officer.PersonID}" ${selected}>${fullName}</option>
            `);
        });
    });

    $("#editUsers").modal("show");
});

function formatDate2(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
        return dateString;
    }
    return date.toISOString().split("T")[0];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
        return dateString;
    }
    return date.toISOString().split("T")[0];
}



$(document).ready(function () {
    $("#editForm").submit(function (e) {
        e.preventDefault();

        $.ajax({
            url: "/payments/update-payment", 
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                paymentID: $("#edit_paymentID").val(),
                paymentDate: $("#edit_paymentDate").val(),
                modeOfPayment: $("#edit_modePayment").val(),
                amountPaid: $("#edit_amountPaid").val(),
                remarks: $("#edit_remarks").val(),
                balance: $("#edit_balance").val(),
                dateReceived: $("#edit_dateReceived").val(),
                officerID: $("#edit_officerId").val()
            }),
            dataType: "json",


            success: function (response) {
                if (response.status === "success") {
                    alert(response.message);
                    $("#editUsers").modal("hide");
                    location.reload(); // Refresh the page to update the table
                } else {
                    alert("Error: " + response.message);
                }
            },
            error: function () {
                alert("An error occurred while updating the payment.");
            }
        });
    });
});




 $(document).ready(function () {
        $.ajax({
            url: "/get-payment-modes",
            method: "GET",
            dataType: "json",
            success: function (modes) {
                let paymentSelect = $("#new_modpayment");
                modes.forEach(mode => {
                    paymentSelect.append(`<option value="${mode}">${mode}</option>`);
                });
            },
            error: function () {
                alert("Error fetching payment modes.");
            },
        });
    });
 $(document).ready(function () {
        $.ajax({
            url: "/get-remarks",
            method: "GET",
            dataType: "json",
            success: function (remarks) {
                let remarksSelect = $("#new_remarks");
                remarks.forEach(remark => {
                    remarksSelect.append(`<option value="${remark}">${remark}</option>`);
                });
            },
            error: function () {
                alert("Error fetching remarks.");
            },
        });
    });
$("#new_paymentdate").attr("max", new Date().toISOString().split("T")[0]);
$("#new_dateReceived").attr("max", new Date().toISOString().split("T")[0]);

        $(document).ready(function () {
    $("#newPaymentForm").submit(function (e) {
        e.preventDefault(); 

        let formData = {
            revenueId: $("#new_revenueId").val(),
            paymentDate: $("#new_paymentdate").val(),
            modeOfPayment: $("#new_modpayment").val(),
            amountPaid: $("#new_amountPaid").val(),
            remarks: $("#new_remarks").val(),
            balance: $("#new_balance").val(),
            dateReceived: $("#new_dateReceived").val(),
            officerId: $("#new_officerId").val()
        };
        $.ajax({
            url: "/add-payment",
            method: "POST",
            data: formData,
            dataType: "json",
            success: function (response) {
                alert(response.message);
                $("#newPaymentForm")[0].reset(); 
                window.location.reload();
            },
            error: function () {
                alert("Error adding payment.");
            },
        });
    });
});


        $(document).ready(function () {
    $.ajax({
        url: "/get-officers",
        method: "GET",
        dataType: "json",
        success: function (data) {
            let dropdown = $("#new_officerId");
            dropdown.empty().append('<option value="">Select Officer</option>');

            data.forEach((officer) => {
                dropdown.append(
                    `<option value="${officer.PersonID}">${officer.FirstName} ${officer.LastName}</option>`
                );
            });
        },
        error: function () {
            console.error("Error fetching officers.");
        },
    });
});



        $(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const revenueId = urlParams.get("revenueId");

     $('#new_revenueId').val(revenueId);

    if (revenueId) {
        fetch(`/payments/${revenueId}`)
            .then(response => response.json())
            .then(data => {
                const theEventName = data[0].EventName;
                const theEventDate = new Date(data[0].EventDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });


                const tableBody = $("#paymentTableBody");
                tableBody.empty();

                let totalRows = 0;
                let totalAmountPaid = 0; 
                let totalBalance = 0;

                if (data.length === 0) {
                    const noDataMessage = `<p>No data available.</p>`;
                    tableBody.append(noDataMessage);
                } else {
                    data.forEach(payment => {
                        const paymentDate = new Date(payment.PaymentDate);
                        const eventtDate = new Date(payment.EventDate);
                        const formattedPaymentDate = paymentDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        const formattedeventdate = eventtDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        const dateReceived = payment.DateReceived ? new Date(payment.DateReceived) : null;
                        const formattedDateReceived = dateReceived ? dateReceived.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) : "N/A";

                        const row = `
                            <tr>
                                <td>${formattedPaymentDate}</td>
                                <td>${payment.ModeOfPayment}</td>
                                <td>${payment.AmountPaid.toFixed(2)}</td>
                                <td>${payment.Remarks}</td>
                                <td>${payment.Balance ? payment.Balance.toFixed(2) : "0.00"}</td>
                                <td>${formattedDateReceived}</td>
                                <td>${payment.OfficerFirstName || ""} ${payment.OfficerLastName || ""}</td>
                                <td>
                                <button style="margin:3px;margin-top: 4px" class="btn btn-secondary btn-sm edit-btn" data-payment-id="${payment.PaymentID}" data-toggle="modal" data-target="#editUsers" >Edit</button>
                                    <button style="margin:3px" class="btn btn-danger btn-sm delete-btn" data-payment-id="${payment.PaymentID}">Delete</button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                         totalRows++; 
                         totalAmountPaid += payment.AmountPaid;
                         totalBalance += payment.Balance;
                    });

                    

                    $('#TheEventName').text(`${theEventName}`);
                    $('#TheEventDate').text(`${theEventDate}`);
                    $('#TotalRows').text(`${totalRows}`);
                    $('#TotalAmountPaid').text(`${totalAmountPaid.toFixed(2)}`);
                    $('#totalBalance').text(`${totalBalance.toFixed(2)}`);

                    
                }
            })
            .catch(error => console.error("Error fetching payments:", error));
    }
});

$(document).on("click", ".delete-btn", function () {
    const paymentID = $(this).data("payment-id");
    const row = $(this).closest("tr");


    if (confirm("Are you sure you want to delete this payment?")) {
        $.ajax({
            url: `/delete-payment/${paymentID}`,
            type: "DELETE",
            success: function (response) {
                alert(response.message);
                window.location.reload();
            },
            error: function (xhr) {
                alert(xhr.responseJSON?.error || "Error deleting payment.");
            }
        });
    }
});




    document.getElementById('search').addEventListener('input', function() {
    let searchQuery = this.value.toLowerCase();
    let table = document.getElementById('paymenttabledata');
    let rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        let row = rows[i];
        let cells = row.getElementsByTagName('td');
        
        let matches = false;
        for (let j = 0; j < cells.length; j++) {
            let cell = cells[j];
            if (cell) {
                let cellText = cell.textContent || cell.innerText;
                if (cellText.toLowerCase().includes(searchQuery)) {
                    matches = true;
                    break; 
                }
            }
        }
        
        if (matches) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
});
    </script>
        <!-- Javascripts -->
        <script src="assets/plugins/jquery/jquery-3.1.0.min.js"></script>
        <script src="assets/plugins/bootstrap/popper.min.js"></script>
        <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/plugins/jquery-slimscroll/jquery.slimscroll.min.js"></script>
        <script src="assets/js/lime.min.js"></script>
        <script src="assets/js/pages/todo.js"></script>
    </body>
</html>